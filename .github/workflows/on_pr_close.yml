name: on pr close

on:
  pull_request:
    types: 
    - closed
    branches:
    - dev
    - main

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      this_version: ${{ steps.this_version.outputs.this_version }}
      next_version: ${{ steps.next_version.outputs.next_version }}

    steps:
      - 
        # Read the current version number from git ls-remote
        id: this_version
        shell: bash
        run: |
          echo "this_version=$(git ls-remote --tag origin | cut -d '/' -f 3 | sort -V | grep -E '^[0-9]+\.[0-9]+\.[0-9]+$' | tail -1)" >> $GITHUB_OUTPUT
      - 
        # Increment the patch version number by one
        id: next_version
        run: |
          major=$(echo "${{ steps.this_version.outputs.this_version }}" | awk -F'.' '{print $1}')
          minor=$(echo "${{ steps.this_version.outputs.this_version }}" | awk -F'.' '{print $2}')
          patch=$(echo "${{ steps.this_version.outputs.this_version }}" | awk -F'.' '{print $3}')

          if [[ "${{ github.event.pull_request.baseRefName }}" = "refs/heads/main" ]]; then
            minor=$((minor+1))
            patch=0
          elif [[ "${{ github.event.pull_request.baseRefName }}" = "refs/heads/dev" ]]; then
            patch=$((patch+1))
          fi
          
          next_version="${major}.${minor}.${patch}"
          echo "Updating version to $next_version"
          echo "next_version=$next_version" >> $GITHUB_OUTPUT

  merge_job:
    # this job will only run if the PR has been merged
    # the a semantic versioned tag will be incremented based on branch
    if: github.event.pull_request.merged == true
    uses: ./.github/workflows/on_wfc_docker_build.yml
    with:
      image_tag: ${{ github.event.pull_request.head.ref }}-${{ github.event.pull_request.number }}
    secrets: inherit